<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="mysql-unit : Testing framework for stored routines in MySQL" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>mysql-unit</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/almadomundo/mysql-unit">View on GitHub</a>

          <a href='/index.html'><h1 id="project_title">mysql-unit</h1></a>
          <h2 id="project_tagline">Testing framework for stored routines in MySQL</h2>
          <section>
              <h3 id="project_menu">
                  +--------------+---------------+---------+<br/>
                  | <a class="menu" href='/installation.html'>Installation</a> | <a class="menu" href='/manual.html'><strong>Documentation</strong></a> | <a class="menu" href='/samples.html'>Samples</a> |<br/>
                  +--------------+---------------+---------+<br/>
                  1 row in set (0.00 sec)
                  </h3>
          </section>
            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/almadomundo/mysql-unit/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/almadomundo/mysql-unit/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="writing-tests" class="anchor" href="#writing-tests"><span class="octicon octicon-link"></span></a>Writing tests</h1>
<p>Before continue reading, make sure that you've read <a href='/api.html#storage-structure'>test storage structure</a> page. In this section there is an overview of how to create your tests with using testing storage. Currently, this could be done only in manual mode (so, by executing usual SQL statements), but in future the corresponding API will be added.</p>
<a name="procedures-tests" class="anchor" href="#procedures-tests"><p><strong>Procedures tests</strong></p></a>
<p>In mysql-unit repository, there is a sample tests file, which is called <a href='https://github.com/almadomundo/mysql-unit/blob/master/5.6/Storage/Samples/tests.dummy_proc.sql'><strong><code>tests.dummy_proc.sql</code></strong></a>. It will create some tests for procedure, which is called <strong><code>DUMMY_PROC</code></strong> (if you want, you may check out it's creation sql <a href='https://github.com/almadomundo/mysql-unit/blob/master/5.6/Storage/Samples/dummy_proc.create.sql'>here</a>). Here are comments to that file:</p>
<pre>
-- Tests for dummy procedure
-- dummy_proc should:
-- 1. Create table in current database with name as passed first argument
-- 2. Add second argument to created table as a column
-- 3. Set type of column as third argument
</pre>
<p>This is about description of what <strong><code>DUMMY_PROC</code></strong> should do. From that follows, that to write desired tests, we need:</p>
<ul>
    <li>Add the record into <strong><code>TEST_PROCEDURE_ASSERTIONS</code></strong> table. If the call is supposed to be error, then add <em><code>is_error</code></em> flag together with expected <em><code>error_code</code></em></li>
    <li>Add arguments into <strong><code>TEST_PROCEDURE_ARGUMENTS</code></strong> table. Our procedure has three arguments, so that should be three records per one test in that table</li>
    <li>Finally, add some checks into <strong><code>TEST_PROCEDURE_RESULTS</code></strong> table. That may be custom expressions, DDL checks e t.c.</li>
</ul>
<p>In the file, that linked above, there is only one test for procedure <strong><code>DUMMY_PROC</code></strong>. Let's see what it is:</p>
<p><strong>1.</strong> First thing to do. We just adding the record to main table, which tells: "This is a record for testing procedure 'dummy_proc' and this call should not throw any error".</p>
<pre>
INSERT INTO TEST_PROCEDURE_ASSERTIONS
(`procedure_name`, `is_error`, `error_code`)
VaLUES
('dummy_proc', 0, NULL);
</pre>
<p><strong>2.</strong> We need to capture, what is our <em><code>id</code></em>, because it will be referenced from child tables:</p>
<pre>
SET @test_id_tmp_mysql_unit:=LAST_INSERT_ID();
</pre>
<p><strong>3.</strong> Next, our procedure call should have some arguments. The statement below corresponds to call: <strong><code>CALL DUMMY_PROC("foo", "bar", "VARCHAR(255)")</code></strong>:</p>
<pre>
INSERT INTO TEST_PROCEDURE_ARGUMENTS
(`test_id`, `argument_value`)
VALUES
(@test_id_tmp_mysql_unit, '"foo"'),
(@test_id_tmp_mysql_unit, '"bar"'),
(@test_id_tmp_mysql_unit, '"VARCHAR(255)"');
</pre>
<p><strong>4.</strong> Finally, we want to add a check, if our table was created and check that created table has the corresponding column:</p>
<pre>
INSERT INTO TEST_PROCEDURE_RESULTS
(`test_id`, `ref_expression`, `ref_value`, `ref_is_error`, `ref_error_code`)
VALUES
(@test_id_tmp_mysql_unit, 'CHECK_DDL_TABLE_EXISTS()', 1, 1, '1318'),
(@test_id_tmp_mysql_unit, 'CHECK_DDL_COLUMN_EXISTS("", "foo", "bar")', 1, 0, NULL);
</pre>
<p><em>What will actually happen, when test procedure will run:</em></p>
<p>Well, here we are:</p>
<pre>
mysql> CALL TEST_PROCEDURE_VERBOSE('dummy_proc');
Query OK, 0 rows affected (0.46 sec)
</pre>
<p>All tests passed, because:</p>
<ul>
    <li>First expression is incorrect, because <em><code>CHECK_DDL_TABLE_EXISTS</code></em> expects 3 parameters (check the corresponding manual page). However, our check has <em><code>is_error</code></em> flag set together with proper <em><code>error_code</code></em> (which is 1318 for this exception)</li>
    <li>Second expression is correct. Since our call was successful (we've passed correct arguments), the table was created and the column in it too. Therefore, test passed, and, since it's the last test and last check for our procedure, the system returned success tests passing result.</li>
</ul>
<a name="functions-tests" class="anchor" href="#functions-tests"><p><strong>Writing tests for functions</strong></p></a>
<p>Function tests are easy, because they affect only one table, <strong><code>TEST_FUNCTION_ASSERTIONS</code></strong>. So writing tests for functions is nothing more than just executing <em><code>INSERT</code></em> statements on that table. Let's test mysql built-in function <em><code>DATABASE()</code></em>. Our current database is "test", so:</p>
<p><strong>1.</strong>Simple success test:</p>
<pre>
INSERT INTO TEST_FUNCTION_ASSERTIONS 
(`function_name`, `expression`, `value`, `is_error`, `error_code`) 
VALUES 
('DATABASE', 'DATABASE()', 'test', 0, NULL);
</pre>
<p><strong>2.</strong>More complicated expression:</p>
<pre>
INSERT INTO TEST_FUNCTION_ASSERTIONS 
(`function_name`, `expression`, `value`, `is_error`, `error_code`) 
VALUES 
('DATABASE', 'CONCAT(CHAR(73), " am ", DATABASE(), "er") REGEXP "^I"', '1', 0, NULL);
</pre>
<p><strong>3.</strong>And invalid expression:</p>
<pre>
INSERT INTO TEST_FUNCTION_ASSERTIONS 
(`function_name`, `expression`, `value`, `is_error`, `error_code`) 
VALUES 
('DATABASE', 'DATABASE("foo")', '', 1, "1064");
</pre>
<p><em>That's it for now, run our tests:</em></p>
<pre>
mysql> CALL TEST_FUNCTION('DATABASE');
ERROR 1644 (80300): Test id < 3 > : expectation of specific ERROR CODE failed.
</pre>
<p>Wait, what? This seems like something weird happened. Look here:</p>
<pre>
mysql> SELECT DATABASE('foo');
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''foo')' at line 1
</pre>
<p>This clearly states that error is "1064", which we specified on third step. This is a bug in mysql-unit! Actually - it isn't. To understand, what is wrong, we first should check testing trace:</p>
<pre>
mysql> CALL TEST_FUNCTION_VERBOSE('DATABASE');
+---------+-----------------+------------+---------------+--------------------------+------------------------+-----------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| test_id | test_expression | test_value | test_is_error | test_error_code_expected | test_error_code_thrown | test_error_message_thrown                                             | test_trace                                                                                                                                                                                                             |
+---------+-----------------+------------+---------------+--------------------------+------------------------+-----------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|       3 | DATABASE("foo") |            |             1 | 1064                     | 1243                   | Unknown prepared statement handler (eval_mysql_unit) given to EXECUTE | Test id < 3 > : expectation that expression ( DATABASE("foo") ) throws ERROR CODE 1064, failed. Actual ERROR CODE thrown is "1243" with message: Unknown prepared statement handler (eval_mysql_unit) given to EXECUTE |
+---------+-----------------+------------+---------------+--------------------------+------------------------+-----------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</pre>
<p>So, that's it. We've faced one of restrictions for mysql-unit. It uses prepared statements to evaluate dynamic SQL in expression, and they will fail if the SQL contains syntax errors. I.e.: preparation of statement will fail, then unknown statement handler will be passed to execution and then error 1243 will occur. In this section, it's just a brief overview of this corner case, but mysql-unit has such restrictions, you can check them on the <a href='/restrictions.html'>restrictions</a> page. The outcome here is: testing built-id MySQL functions in general is a bad idea.</p>
</section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">mysql-unit maintained by <a href="https://github.com/almadomundo">almadomundo</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
